name: "OBIS D0 Reader"
version: "1.3.1"
slug: obis_d0_reader
description: "Reads OBIS D0 electricity meters via ser2net and sends data to MQTT"
arch:
  - aarch64
  - amd64
  - armhf
  - armv7
  - i386
url: "https://github.com/lejando/homeassistant-obis"
startup: application
boot: auto
init: false

options:
  # ═══════════════════════════════════════════════════════════════════════════
  # TCP/IP Connection Settings
  # ═══════════════════════════════════════════════════════════════════════════
  # Configure the connection to your ser2net server (Raspberry Pi with IR head)

  # IP address or hostname of your ser2net server
  # Examples: "192.168.1.100", "raspberrypi.local"
  # Find it: Run "hostname -I" on your Raspberry Pi
  tcp_host: "192.168.1.100"

  # TCP port where ser2net is listening
  # Default: 3000 (check your ser2net config: /etc/ser2net/ser2net.yaml)
  # Test connection: telnet YOUR_IP 3000
  tcp_port: 3000

  # ═══════════════════════════════════════════════════════════════════════════
  # MQTT Broker Settings
  # ═══════════════════════════════════════════════════════════════════════════
  # Configure connection to your MQTT broker for sending sensor data

  # Enable/disable MQTT publishing
  # Set to false only for testing TCP connection
  mqtt_enabled: true

  # MQTT broker hostname or IP address
  # Use "core-mosquitto" if you're using the Mosquitto add-on in Home Assistant
  # Examples: "core-mosquitto", "192.168.1.50", "mqtt.example.com"
  mqtt_host: "core-mosquitto"

  # MQTT broker port
  # Default: 1883 (unencrypted), 8883 (SSL/TLS)
  mqtt_port: 1883

  # MQTT username (leave empty if no authentication required)
  # Default Mosquitto add-on doesn't require authentication
  mqtt_user: ""

  # MQTT password (leave empty if no authentication required)
  mqtt_password: ""

  # Base MQTT topic for all sensor data
  # Format: {base_topic}/{sensor_name}/state
  # Example: "homeassistant/sensor/obis/power_total/state"
  mqtt_base_topic: "homeassistant/sensor/obis"

  # Enable MQTT Auto-Discovery for Home Assistant
  # When enabled: Sensors automatically appear in HA without manual configuration
  # Go to: Settings → Devices & Services → MQTT to see your meter
  mqtt_discovery: true

  # MQTT Discovery prefix (must match Home Assistant MQTT integration)
  # Default Home Assistant value: "homeassistant"
  # Verify: Settings → Devices & Services → MQTT → Configure
  mqtt_discovery_prefix: "homeassistant"

  # ═══════════════════════════════════════════════════════════════════════════
  # Advanced MQTT Topic Configuration
  # ═══════════════════════════════════════════════════════════════════════════
  # Configure how sensor data is published to MQTT topics

  # Topic generation mode:
  # - "auto": Automatic topic generation (recommended for Home Assistant)
  #           Format: {mqtt_base_topic}/{sensor_name}/state
  # - "custom": Define custom topics for each sensor (advanced users)
  #           Use this for integration with Node-RED, Grafana, ioBroker, etc.
  mqtt_topic_mode: "auto"

  # Custom MQTT topic mappings (only used when mqtt_topic_mode: "custom")
  # Format:
  #   "source": "target/topic"
  #
  # Source can be OBIS code or sensor name:
  #   "1-0:16.7.0*255": "energy/power/current"
  #   "power_total": "nodered/power"
  #
  # Available sensor names:
  #   device_id, meter_id, total_energy_import, total_energy_export,
  #   power_total, power_l1, power_l2, power_l3,
  #   voltage_l1, voltage_l2, voltage_l3,
  #   current_l1, current_l2, current_l3,
  #   frequency, device_status, operating_time
  #
  # Example for multi-system integration:
  # mqtt_custom_topics:
  #   "power_total": "nodered/energy/power"
  #   "total_energy_import": "grafana/energy/import"
  #   "voltage_l1": "monitoring/grid/voltage/phase1"
  mqtt_custom_topics: {}

  # ═══════════════════════════════════════════════════════════════════════════
  # openWB Integration Settings
  # ═══════════════════════════════════════════════════════════════════════════
  # Configure data forwarding to openWB (Open Wallbox) for EV charging control

  # Enable/disable openWB MQTT forwarding
  # Set to true if you want to send meter data to an openWB wallbox system
  openwb_enabled: false

  # openWB MQTT broker hostname or IP address
  # This is usually the IP address of your openWB device
  # Examples: "192.168.1.50", "openwb.local"
  openwb_mqtt_host: "192.168.1.50"

  # openWB MQTT broker port
  # Default: 1883 (unencrypted)
  openwb_mqtt_port: 1883

  # openWB MQTT username (leave empty if no authentication required)
  # Most openWB installations don't require authentication
  openwb_mqtt_user: ""

  # openWB MQTT password (leave empty if no authentication required)
  openwb_mqtt_password: ""

  # openWB device ID for the counter
  # This is the device number used in openWB topics
  # Default: 8 (MQTT module counter)
  # Topics will be: openWB/set/mqtt/counter/{device_id}/get/...
  openwb_device_id: 8

  # ═══════════════════════════════════════════════════════════════════════════
  # Meter Settings
  # ═══════════════════════════════════════════════════════════════════════════

  # Friendly name for your electricity meter
  # Used as device name in Home Assistant
  # Sensor names will be: "{meter_name} Power Total", etc.
  # Examples: "easyMeter", "MainMeter", "Basement_Meter"
  meter_name: "easyMeter"

  # Polling interval in seconds (how often to read data from meter)
  # Range: 1-60 seconds
  # Recommended values:
  #   2  = Real-time monitoring (best for power tracking)
  #   5  = Balanced (good compromise)
  #   10 = Reduced network traffic
  #   30 = Minimal polling (energy totals only)
  # Note: Energy Dashboard accuracy is not affected by polling interval
  poll_interval: 2

  # Automatically calculate power factors when not provided by meter
  # Power factor (cos φ) will be calculated from power, voltage, and current
  # using the formula: cos φ = P / (U × I)
  # Only calculates when all three values are measured by the meter (not calculated)
  # Set to true if you want to enable power factor calculation
  # Leave false if your meter already provides power factor values
  # or if you don't need power factor sensors
  calculate_power_factor: false

  # ═══════════════════════════════════════════════════════════════════════════
  # Logging Settings
  # ═══════════════════════════════════════════════════════════════════════════

  # Log verbosity level:
  # - "debug": Most verbose, shows all operations, raw data, and details
  #            Use for troubleshooting connection or parsing issues
  # - "info": Normal operation, shows connections, updates, and errors
  #           Recommended for daily use
  # - "warning": Only warnings and errors
  #              Use in production when system is stable
  # - "error": Only errors and critical failures
  log_level: "info"

schema:
  tcp_host: str
  tcp_port: int
  mqtt_enabled: bool
  mqtt_host: str
  mqtt_port: int
  mqtt_user: str?
  mqtt_password: str?
  mqtt_base_topic: str
  mqtt_discovery: bool
  mqtt_discovery_prefix: str
  mqtt_topic_mode: list(auto|custom)
  openwb_enabled: bool
  openwb_mqtt_host: str
  openwb_mqtt_port: int
  openwb_mqtt_user: str?
  openwb_mqtt_password: str?
  openwb_device_id: int
  meter_name: str
  poll_interval: int(1,60)
  calculate_power_factor: bool
  log_level: list(debug|info|warning|error)

services:
  - mqtt:want

# Image is automatically set by the build system when build.yaml is present
